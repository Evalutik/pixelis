#!/bin/sh
# Pre-commit hook: prevent committing .env/secrets, run PHP lint, basic checks
set -e

staged_files=$(git diff --cached --name-only --diff-filter=ACM)

# Prevent adding .env
if echo "$staged_files" | grep -qE '^.*/?\.env$|^\.env$'; then
  echo "ERROR: .env is staged. Remove it and keep secrets out of the repo." >&2
  exit 1
fi

# Check for obvious secret patterns in staged content
for f in $staged_files; do
  if [ -f "$f" ]; then
    # Skip internal hook files and example files (they contain placeholders)
    if echo "$f" | grep -qE '^\.githooks/|\.example$|\.dist$'; then
      continue
    fi
    if git show :"$f" | grep -E 'DB_PASS=|DB_USER=|DB_HOST=|API_KEY|SECRET|AWS_SECRET' >/dev/null 2>&1; then
      echo "ERROR: Possible secret pattern found in $f. Abort commit." >&2
      git show :"$f" | grep -En 'DB_PASS=|DB_USER=|DB_HOST=|API_KEY|SECRET|AWS_SECRET' >&2 || true
      exit 1
    fi
  fi
done

# PHP lint on staged PHP files (best-effort on working tree)
if command -v php >/dev/null 2>&1; then
  for f in $staged_files; do
    case "$f" in
      *.php)
        if ! php -l "$f" >/dev/null 2>&1; then
          echo "PHP syntax error in $f" >&2
          php -l "$f" || true
          exit 1
        fi
        ;;
    esac
  done
else
  echo "WARNING: php not found in PATH â€” skipping PHP lint (install php-cli to enable)." >&2
fi

# If php-cs-fixer exists, run in dry-run mode
if command -v php-cs-fixer >/dev/null 2>&1; then
  echo "Running php-cs-fixer (dry-run)..."
  php-cs-fixer fix --dry-run --diff || true
fi

exit 0
